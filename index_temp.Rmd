---
title: "Gentrification and Displacement in Buffalo, NY"
author: "Nino Martinez"
subtitle: Using Census and Open Data to Map Neighborhood Change
---

# Introduction


   In September of 2017, the city of Buffalo announced the reassessment of over 95,000 properties, which will be the first reassessment done since 2010. Officials say, “The purpose of a property reassessment is to establish uniform, fair, and equitable assessments on all real property types” (Slawson, 2017).  The total assessment value of each residential tax parcel determines how much a homeowner pays in property taxes each year, thus contributes to the development of city infrastructure. In recent years, some residential tax parcels have sold for much more than the assessed value, and are located in neighborhoods where revitalization efforts have taken place. The problem is that in some neighborhoods “property values have shot up so drastically that some homeowners are facing 30% tax increases, or more, compared to when they purchased their affordable homes a decade ago” (Buffalo Rising, 2018).
   
   
  In recent years, some neighborhoods in Buffalo, NY have experienced a substantial increase in the prosperity of the population, others, however, experienced increasing levels of concentrated disadvantage. Here, I use the definition of gentrification given by The Encyclopedia of Housing as “the process by which central urban neighborhoods that have undergone disinvestments and economic decline experience a reversal, reinvestment, and the in-migration of a relatively well-off, middle- and upper middle class population” (Freeman, 2080). Gentrification can displace marginalized populations and most literature document that residential displacement results from increasing rent prices and or home values, no longer affordable for the residing population prior to neighborhood revitalization (LeGates & Hartman 32). 
  
  > Gentrification is the process by which central urban neighborhoods that have undergone disinvestments and economic decline experience a reversal, reinvestment, and the in-migration of a relatively well-off, middle- and upper middle class population. ~ The Encyclopedia of Housing


 Despite the growing demand for up-to-date data that could provide insight into mitigation strategies for the negative consequences of gentrification, only a few studies “attempt to measure gentrification systematically or document the extent and the form of displacement due to gentrification” (Holm & Schulz, 251). Traditional methods of measuring gentrification rely heavily on census data and analyzing key indicators of neighborhood change, such as increasing percentage of white population, higher incomes, and rising rents (Heidkamp & Lucas, 104). This methodology is not able to analyze changing neighborhood dynamics in close-to-real time due to the infrequency of community surveys and the year lag time in results. In addition, as the geographic unit gets smaller, accuracy of the data also diminishes due to higher margins of error, thus blurring both perceived and established neighborhood boundaries in the dynamics of the change. New methods of quantifying changing cities are arising with the “emerging cloud of Big Data” that prove useful to supplement traditional methods to measure gentrification and displacement (Zook et al.) Open data portals provided by local government agencies are also incredibly valuable. These publically available datasets can provide useful information on neighborhood change at the household level. 


  The purpose of this project is to use the city of Buffalo’s Open Data Portal to analyze, visualize, and quantify gentrification based on the sold price of residential tax parcels above the total assessment value, and understand which changing socioeconomic variables play a role in the sale price of residential parcels over its assessed value. Very little academic literature discusses and analyses gentrification in Rust-Belt cities, but what exists says; “In Rust Belt cities like Buffalo, the [displacement] trend plays out differently than in booming coastal cities like San Francisco and New York. But for all these urban centers, increased public and private investment in downtown neighborhoods combined with changing cultural preferences toward urban lifestyles are changing the fabric of these cities in ways scarcely imagined a decade or two ago” (Sherman, 3). Quantifying displacement is problematic due to “lacking the ability to track ‘displacees’” (Atkinson, 149), which happens when data is not available at the individual level to understand migration patterns. Therefore, this project does not empirically analyze displacement, rather, it combines available tax parcel assessment and census data to analyze gentrification, then maps populations that are at the greatest risk of displacement based on potentially rising property taxes due to the city of Buffalo’s reassessment project.
	

> In Rust Belt cities like Buffalo, the [displacement] trend plays out differently than in booming coastal cities like San Francisco and New York. But for all these urban centers, increased public and private investment in downtown neighborhoods combined with changing cultural preferences toward urban lifestyles are changing the fabric of these cities in ways scarcely imagined a decade or two ago.  ~ Danya Sherman

# Data & Methods
1. To Analyse Concentrated Disadvantage for preliminary analysis of gentrifiable census tracts
- **Source:** [Neighborhood Change Database (NCDB)](http://www.geolytics.com/USCensus,Neighborhood-Change-Database-1970-2000,Products.asp)

-*Decline70_00.csv*

-**Source:** [U.S. Census Tiger Data](https://www.census.gov/geo/maps-data/data/tiger.html)

- *Buffalo.shp*
        
-**Source:** [Open data Buffalo Portal](https://data.buffalony.gov/)

- *neighborhoods.shp*

2. To Quantify Gentrification
  - 2018-2019 Assessment Roll (.csv)
  - Neighborhood boundaries (.shp)
3. Census Data
  - 2010 U.S. Census Bureau American Community Survey 5-year Estimates (2006-2010)
  - 2016 U.S. Census Bureau American Community Survey 5-year Estimates (2012-2016)
  - City census tract boundaries (.shp)
  
# Methodology

## Measuring Concentrated Disadvantage

In order to properly quantify gentrification, it is necessary to measure urban decline and concentrated disadvantage within the city historically. “By definition, gentrification is reinvestment in and rebuilding of the physical structures that have undergone a period of disinvestment" (Heidkamp & Lucas, 107). Neighborhoods that experience a period of disinvesment are often concentrated in disadvantage. Circumstances that make success (most often economically) unusually difficult make places disadvantaged, and “the presence of disadvantage weakens a place’s ability to achieve this goal [economic success]” (Weaver et al, 35). When multiple layers of disadvantage occur in a single location, concentrated disadvantage exists (36). By using the geometric mean of five disadvantage variables provided by the NCDB, I calculate concentrate disadvantage (CD) for the years 1970-2000. I use the same variables used by Weaver et al, 2017 in my calculations because all variables are represented as percentages, thus making comparisons across time consistent as they range from a value of 0-100. The equation is represented as:

**$Gi  = [(Percent Nonwhitei)* (Percent Female Headed Householdsi) * (Percent Unemployedi) * (Percent in Povertyi) * (Percent Low Educationi)]^1/5, i: 1, 2, …, n$**

```{r message = FALSE, warning=FALSE}
#load all necessary libraries for analysis
library(dplyr)
library(tidyverse)
library(ggplot2)
library(tmap)
library(broom)
library(ggmap)
library(sp)
library(sf) 
library(reshape2)

```

```{r warning=FALSE, message=FALSE}
# For reproducability, set working directory to the data folder of your cloned/downloaded file


decline <- read.csv("Data/Decline70_00.csv")

#Select attributes relevant to 1970 concentrated disadvantage

index70 <- select(decline, GeoID, Pop_70, PerWhite_70, PerFHH_70, Edu08_70, Edu812_70, X25Pop_70, PerPov_70, PerUnEmp_70) 

# Create new columns for percent nonwhite and percent undereducated

geoindex70 <- mutate(index70, 
                     PerLowEdu70 = (Edu08_70 + Edu812_70)/X25Pop_70,
                     PerNonWhite70 = 1 - PerWhite_70) 

# Calculate the geometric index of concentrated disadvantage in 1970 

disadvantage70 <- mutate(geoindex70,
                         index_70 = (PerNonWhite70 * PerFHH_70 * PerUnEmp_70 * PerPov_70 * PerLowEdu70)^(1/5)*100)

# Create new df only the GeoID and the geometric index of concentrated disadvantage for joining and mapping later

conDis_1970 <- select(disadvantage70, GeoID, index_70)


```
Repeat steps for 1980, 1990, and 2000

```{r message=FALSE, warning=FALSE}
# 1980

index80 <- select(decline, GeoID, Pop_80, PerWhite_80, PerFHH_80, Edu08_80, Edu812_80, X25pop_80, PerPov_80, PerUnemp_80)

geoindex80 <- mutate(index80, 
                     PerLowEdu80 = (Edu08_80 + Edu812_80)/X25pop_80,
                     PerNonWhite80 = 1 - PerWhite_80)

disadvantage80 <- mutate(geoindex80,
                         index_80 = (PerNonWhite80 * PerFHH_80 * PerUnemp_80 * PerPov_80 * PerLowEdu80)^(1/5)*100)

conDis_1980 <- select(disadvantage80, GeoID, index_80)

#1990

index90 <- select(decline, GeoID, Pop_90, PerWhite_90, PerFH_90, Edu08_90, Edu812_90, X25pop_90, PovPer_90, PerUnEmp_90)

geoindex90 <- mutate(index90, 
                     PerLowEdu90 = (Edu08_90 + Edu812_90)/X25pop_90,
                     PerNonWhite90 = 1 - PerWhite_90)

disadvantage90 <- mutate(geoindex90,
                         index_90 = (PerNonWhite90 * PerFH_90 * PerUnEmp_90 * PovPer_90 * PerLowEdu90)^(1/5)*100)

conDis_1990 <- select(disadvantage90, GeoID, index_90)

# 2000

index00 <- select(decline, GeoID, Pop_00, PerWhite_90.1, PerFHH_00, Edu08_00, Edu812_00, X25Pop_00, PerPov_00, PerUnEmp_00)

geoindex00 <- mutate(index00, 
                     PerLowEdu00 = (Edu08_00 + Edu812_00)/X25Pop_00,
                     PerNonWhite00 = 1 - PerWhite_90.1)

disadvantage00 <- mutate(geoindex00,
                         index_00 = (PerNonWhite00 * PerFHH_00 * PerUnEmp_00 * PerPov_00 * PerLowEdu00)^(1/5)*100)

conDis_2000 <- select(disadvantage00, GeoID, index_00)


```
Join all of the conDis_"year" dataframes so there is just one clean file for mapping

```{r}
conDis_70_80 <- full_join(conDis_1970, conDis_1980, "GeoID", "GeoID")
conDis_70_80_90 <- full_join(conDis_70_80, conDis_1990, "GeoID", "GeoID")
conDis_1970_to_2000 <- full_join(conDis_70_80_90, conDis_2000, "GeoID", "GeoID")

```
Join the Concentrated Disadvantage Data with the Spatial Polygon Data to map and caluculate summary values based off of only City of Buffalo census tracts instead of all of erie county 

```{r message=FALSE, warning = FALSE}
buffalo_tracts <- st_read("Data/Buffalo.shp") #read in shapefile
conDis_1970_to_2000$GeoID <- as.character(conDis_1970_to_2000$GeoID) #Change factor to character to join
Buffalo_ConDis <- full_join(buffalo_tracts, conDis_1970_to_2000, by = c("GEOID10" = "GeoID"))


conDis_70_mean <- mean(Buffalo_ConDis$index_70)
conDis_80_mean <- mean(Buffalo_ConDis$index_80)
conDis_90_mean <- mean(Buffalo_ConDis$index_90)
conDis_00_mean <- mean(Buffalo_ConDis$index_00)

# Calculate the median

conDis_70_median <- median(Buffalo_ConDis$index_70)
conDis_80_median <- median(Buffalo_ConDis$index_80)
conDis_90_median <- median(Buffalo_ConDis$index_90)
conDis_00_median <- median(Buffalo_ConDis$index_00)

# Create a matrices to plot the change in mean concenctrated disadvantage over time

conDis_matrix <- matrix(nrow = 4, ncol = 3, c("1970","1980","1990","2000",conDis_70_mean,conDis_80_mean, conDis_90_mean,conDis_00_mean,conDis_70_median,conDis_80_median, conDis_90_median,conDis_00_median))
colnames(conDis_matrix) <- c("Year", "Mean_Index", "Median_Index" )

#Convert to dataframe for plotting


conDis_df <- as.data.frame(conDis_matrix)

# Spread data to show mean and median in bar chart

conDis_df.2 <- melt(conDis_df, id.vars='Year')


# Change class of value attribute

conDis_df.2$value <- as.numeric(as.character(conDis_df.2$value))

 conDis_plot <- ggplot(data = conDis_df.2, aes(x = Year, y = value, fill = variable)) + geom_bar(stat = "identity", position = "dodge") + ggtitle("Change in Mean and Median Concentrated Disadvantage (CD)", "Buffalo NY 1970-2000 ") + labs(x = "Year", y = "Geometric Index") 


conDis_plot
```

### Preliminary Analysis

From 1970 to 2000, both the average and median geometric index of concentrated disadvantage (CD) nearly doubled, with the most dramatic increase being between the 1970 and 1980. While this shows that disadvantage increased in the city as a whole, it is necessary to analyse the spatial distribution of CD over time within the city as a precursour to the analysis of gentrification. Using the 'tmap' package and the function tmap_arrange, we can evaluate the extent of dispersion in CD.



```{r}
# read in neighborhood shapefile

neighborhoods <- st_read("Data/nbhds.shp")


CD_70_map <-  tm_shape(Buffalo_ConDis) + tm_polygons("index_70", style = "cont",
                                                 palette = "seq",
                                                 n = 7,
                                                 title = "Geometric Index",
                                                 border.alpha = .50) + 
  tm_shape(neighborhoods) + tm_polygons(alpha = 0, border.col = "black") +
  tm_layout(aes.palette = "Reds", legend.outside = TRUE, main.title = "Concentrated Disadvantage 1970", main.title.size = .75)

CD_80_map <-  tm_shape(Buffalo_ConDis) + tm_polygons("index_80", style = "cont",
                                                 palette = "seq",
                                                 n = 7,
                                                 title = "Geometric Index",
                                                 border.alpha = .50) + 
  tm_shape(neighborhoods) + tm_polygons(alpha = 0, border.col = "black") +
  tm_layout(aes.palette = "Reds", legend.outside = TRUE, main.title = "Concentrated Disadvantage 1980", main.title.size = .75)

CD_90_map <-  tm_shape(Buffalo_ConDis) + tm_polygons("index_90", style = "cont",
                                                 palette = "seq",
                                                 n = 7,
                                                 title = "Geometric Index",
                                                 border.alpha = .50) + 
  tm_shape(neighborhoods) + tm_polygons(alpha = 0, border.col = "black") +
  tm_layout(aes.palette = "Reds", legend.outside = TRUE, main.title = "Concentrated Disadvantage 1990", main.title.size = .75)

CD_00_map <-  tm_shape(Buffalo_ConDis) + tm_polygons("index_00", style = "cont",
                                                 palette = "seq",
                                                 n = 7,
                                                 title = "Geometric Index",
                                                 border.alpha = .50) + 
  tm_shape(neighborhoods) + tm_polygons(alpha = 0, border.col = "black") +
  tm_layout(aes.palette = "Reds", legend.outside = TRUE, main.title = "Concentrated Disadvantage 2000", main.title.size = .75)

tmap_arrange(nrow = 2, CD_70_map, CD_80_map, CD_90_map, CD_00_map)
```

CD from 1970 to 2000 spread in an intriguing way, with persistent high indices of disadvantage in the central business district (CBD) and expaning out to the city border on the east and west parts of Buffalo, with compariably low indices in census tracts directly North of the CBD. With the historical context in mind, I evaluate disinvested tracts as any tracts whose geometric index of CD is equal to or greater than the median (CD) of all tracts in the year 2000.

```{r}
conDis_00_median
```
Using the R packages "leaflet", "rgdal", "geojsonio", and "rmapshaper", I created an interactive map that allows users to explore the census tracts within neighborhood boundaries with high levels of CD in order to set the criteria for measuring gentrification.

```{r message=FALSE, warning=FALSE}
# Load necessary packages
library(sp)
library(sf)
library(rgdal)
library(spdplyr)
library(geojsonio)
library(rmapshaper)
library(leaflet)

# Convert sf to sp in order to convert to geojson for interactive mapping with leaflet

Buffalo_ConDis_sp <- as(Buffalo_ConDis, "Spatial") # Concentrated Disadvantage
neighborhoods_sp <- as(neighborhoods, "Spatial") # Neighborhood Boundaries

# Convert to geojson

buffalo_cd_json <- geojson_json(Buffalo_ConDis_sp)
neighborhoods_json <- geojson_json(neighborhoods_sp)

# Simplify the geometry to decrease storage size of spatial object

buffalo_cd_json_simp <- ms_simplify(buffalo_cd_json)
neighborhoods_json_simp <- ms_simplify(neighborhoods_json)

# Write as a geojson to bring back into R for mapping

geojson_write(buffalo_cd_json_simp, file = "city_CD.geojson")
geojson_write(neighborhoods_json_simp, file = "neighborhoods.geojson")

# Read in .geojson to map

city_CD <- geojson_read("city_CD.geojson", what = "sp")
nbhds_json <- geojson_read("neighborhoods.geojson", what = "sp")

# Map for interactive view of concentrated disadvantage

bins <- c(0, 8, 16,24.7, 33, 41, 50.4) # Sets the interval for color scheme
pal_00 <- colorBin("YlOrRd", domain = city_CD$index_00, bins = bins) # Gives seqential color scheme

# Created html popup of index of concentrated disadvantage

labels_00 <- sprintf(
  "<strong>%g index of CD</strong>",
  city_CD$index_00
) %>% lapply(htmltools::HTML)

# Create leaflet map to label by geometric index

CD_Map_2000 <- leaflet() %>% setView(-78.8784, 42.8864, 10.9) %>% addTiles() %>%
  addPolygons(data = nbhds_json, fillOpacity = 0, weight = 3, opacity = 1) %>%
  addPolygons(data = city_CD, fillColor = ~pal_00(index_00),
  weight = 0.5,
  opacity = 0.5,
  color = "white",
  dashArray = "3",
  fillOpacity = 0.5,
  highlight = highlightOptions(
    weight = 5,
    color = "#666",
    dashArray = "",
    fillOpacity = 0.5,
    bringToFront = TRUE),
  label = labels_00,
  labelOptions = labelOptions(
    style = list("font-weight" = "normal", padding = "3px 8px"),
    textsize = "15px",
    direction = "auto")) 

# Create leaflet map to label by neighborhood

CD_nbhd_2000 <- leaflet() %>% setView(-78.8784, 42.8864, 10.7) %>% addTiles() %>%
  addPolygons(data = city_CD, fillColor = ~pal_00(index_00),
              weight = 2,
              opacity = 1,
              color = "white",
              dashArray = "3",
              fillOpacity = 0.5) %>%
  addPolygons(data = nbhds_json, fillOpacity = 0, weight = 1.2,
                          label = nbhds_json$nbhdname) %>%
  addLegend(pal = pal_00, values = city_CD$index_00, opacity = 0.5, title = "Concentrated Disadvantage (%)",
                position = "bottomleft")



disinvested <- Buffalo_ConDis %>% filter(index_00 >= 24.7)
disinvested_sp <- as(disinvested, "Spatial")
disinvested_json <- geojson_json(disinvested_sp)


disinvestment_map <- leaflet() %>% setView(-78.8784, 42.8864, 10.7) %>% addTiles() %>%
  addPolygons(data = disinvested_sp, fillColor = "Black" ,
              weight = 2,
              opacity = .50,
              color = "white",
              dashArray = "3",
              fillOpacity = 0.5) %>%
  addPolygons(data = nbhds_json, fillOpacity = 0, weight = 1.2,
                          label = nbhds_json$nbhdname) 

```


### Explore Buffalo, NY's Areas of Concentrated Disadvantage by Geometric Index (Year 2000)


```{r}
CD_Map_2000
```



### Explore Buffalo, NY's Areas of Concentrated Disadvantage by Neighborhood (Year 2000)



```{r}
CD_nbhd_2000
```

### Neighborhoods of Disinvestment

```{r}
disinvestment_map
```

## Measuring Gentrification: Traditional Methodology
  

In order to measure gentrification, I analyse changes in key variables provided by the U.S. Census Bureau that are used consistently in academic literature (Atkinson 2000, Heidcamp & Lucas 2006, Freeman & Braconi 2004, Holm & Schulz 2017). These variables come from the U.S. Census Bureau's American Community Survey 5-year estimates. I examine change from the 2010 (2006-2010 estimates) and 2016 (2012-2016 estimates). This process involves a lot of data transformation in RStudio, I chose not to use the R package "tidyverse" due to the specific variables needed for analysis and the lack of variable full descriptions within the package. I instead download the required datasets from the US Census Bureau [factfinder](https://factfinder.census.gov/faces/nav/jsf/pages/index.xhtml), and use the meta data to then filter the data by columns for variable selection. Due to the time involved in filtering the data by the metadata, I select variables of interest for future research in addition to the variables for this project alone.

### Economic Variables

```{r}
# Read in all economic variables for 2010
economic_10 <- read.csv("Data/economic_10.csv", skip = 1)

#Filter variables by column number based on metadata

key_economic_10 <- economic_10[,c(2,3,38, 39, 86, 87, 110, 111, 248, 249, 204, 205, 478:479)]

# Make sure the column names are selected correctly



# Create vector for new column names 

economic_names_10 <- c("GEOID10", 
                    "Census_Tract", 
                    "Per_Unemp10", 
                    "Per_Unemp10_MOE",
                    "Per_Public_Trans_10",
                    "Per_Public_Trans10_MOE", 
                    "Per_Occ_Mgmt_10",
                    "Per_Occ_Mgmt10_MOE",
                    "Median_HH_Income_10",
                    "Median_HH_Income_10_MOE",
                    "Num_Households_10",
                    "Num_Households_10_MOE",
                    "Per_Pov_10",
                    "Per_Pov_10_MOE")

# Assign the names to the dataframe

colnames(key_economic_10) <- economic_names_10

# 2016

economic_16 <- read.csv("Data/econ16.csv")

key_economic_16 <- economic_16[,c(2,3,38, 39, 86, 87, 110, 111, 248, 249, 204, 205, 478:479)]



economic_names_16 <- c("GEOID10", 
                    "Census_Tract", 
                    "Per_Unemp16", 
                    "Per_Unemp16_MOE",
                    "Per_Public_Trans_16",
                    "Per_Public_Trans16_MOE", 
                    "Per_Occ_Mgmt_16",
                    "Per_Occ_Mgmt16_MOE",
                    "Median_HH_Income_16",
                    "Median_HH_Income_16_MOE",
                    "Num_Households_16",
                    "Num_Households_16_MOE",
                    "Per_Pov_16",
                    "Per_Pov_16_MOE")
colnames(key_economic_16) <- economic_names_16
```
```{r warning = FALSE, message= FALSE}
# Change values to numbers

# 2010

key_economic_10$Median_HH_Income_10<-as.numeric(as.character(key_economic_10$Median_HH_Income_10))
key_economic_10$Num_Households_10 <- as.numeric(as.character(key_economic_10$Num_Households_10))
key_economic_10$Per_Unemp10 <- as.numeric(as.character(key_economic_10$Per_Unemp10))
key_economic_10$Per_Public_Trans_10<-as.numeric(as.character(key_economic_10$Per_Public_Trans_10))
key_economic_10$Per_Occ_Mgmt_10 <- as.numeric(as.character(key_economic_10$Per_Occ_Mgmt_10))
key_economic_10$Per_Pov_10 <- as.numeric(as.character(key_economic_10$Per_Pov_10))

# 2016
key_economic_16$Median_HH_Income_16<-as.numeric(as.character(key_economic_16$Median_HH_Income_16))
key_economic_16$Num_Households_16 <- as.numeric(as.character(key_economic_16$Num_Households_16))
key_economic_16$Per_Unemp16 <- as.numeric(as.character(key_economic_16$Per_Unemp16))
key_economic_16$Per_Public_Trans_16 <- as.numeric(as.character(key_economic_16$Per_Public_Trans_16))
key_economic_16$Per_Occ_Mgmt_16 <- as.numeric(as.character(key_economic_16$Per_Occ_Mgmt_16))
key_economic_16$Per_Pov_16 <- as.numeric(as.character(key_economic_16$Per_Pov_16))
```

```{r warning = FALSE}
#Combine economic data for 2010 and 2016
# Change to character to join

key_economic_16$GEOID10 <- as.character(key_economic_16$GEOID10)
key_economic_10$GEOID10 <- as.character(key_economic_10$GEOID10)
all_years_economic <- full_join(key_economic_10, key_economic_16, by = c("GEOID10" = "GEOID10")) 

#Calculate changes in economic indicators

economic_change <- all_years_economic %>% mutate(Unemp_Chg = Per_Unemp16 - Per_Unemp10,
                                                 Pub_Tran_Chg =Per_Public_Trans_16-Per_Public_Trans_10,
                                                 Per_Occ_Mgt_Chg = Per_Occ_Mgmt_16 - Per_Occ_Mgmt_10,
                                                 Med_Inc_Chg = Median_HH_Income_16-Median_HH_Income_10,
                                                 Num_House_Chg = Num_Households_16 - Num_Households_10,
                                                 Per_Pov_Chg = Per_Pov_16 - Per_Pov_10)

```


### Education Variables

```{r warning = FALSE, message=FALSE}
# Education 2010

edu_10 <- read.csv("Data/edu_10.csv")

key_edu_10 <- edu_10[,c(2,3,34,35,40,41,46,47,88,89,94,95,112,113)]


edu_names_10 <- c("GEOID10", 
                    "Census_Tract", 
                    "Total_25Plus_10", 
                    "25Plus_MOE_10",
                     "less_9_10",
               "less_9_moe_10",
                     "nd_9_12th_10",
               "nd_9_12_moe_10",
                    "Per_BachelorsPlus_10",
                    "Bachelors_Plus_MOE_10",
               "num_25_34yo_10",
               "num_25_34yo_moe_10",
               "num_35_44yo_10",
               "num_35_44yo_moe_10") 
                    
colnames(key_edu_10) <- edu_names_10

# Sum population 25 and over without a highschool diploma or equivalency and pop 25-44

key_edu_10$less_9_10 <- as.numeric(as.character(key_edu_10$less_9_10))
key_edu_10$nd_9_12th_10 <- as.numeric(as.character(key_edu_10$nd_9_12th_10))

key_edu_10 <- key_edu_10 %>% mutate(per_no_hs_diploma_10 = less_9_10 + nd_9_12th_10,
                                    pop_25_44_10 = num_25_34yo_10 + num_35_44yo_10) #remember to still calculate the percentage once tables are joined



# Education 2016

edu_16 <- read.csv("Data/edu_16.csv", skip = 1)
key_edu_16 <- edu_16[,c(2,3,64,65,78,79,88,89,174,175,184,185,220,221)]


edu_names_16 <- c("GEOID10", 
                 "Census_Tract", 
                 "Total_25Plus_16", 
                 "25Plus_MOE_16",
                 "less_9_16",
                 "less_9_moe_16",
                 "nd_9_12th_16",
                 "nd_9_12_moe_16",
                 "Per_BachelorsPlus_16",
                 "Bachelors_Plus_MOE_16",
                 "num_25_34yo_16",
                 "num_25_34yo_moe_16",
                 "num_35_44yo_16",
                 "num_35_44yo_moe_16")  

colnames(key_edu_16) <- edu_names_16

# Sum population 25 and over without a highschool diploma or equivalency and pop 25-44

key_edu_16$less_9_16 <- as.numeric(as.character(key_edu_16$less_9_16))
key_edu_16$nd_9_12th_16 <- as.numeric(as.character(key_edu_16$nd_9_12th_16))
key_edu_16$num_25_34yo_16 <- as.numeric(as.character(key_edu_16$num_25_34yo_16))
key_edu_16$num_35_44yo_16 <- as.numeric(as.character(key_edu_16$num_35_44yo_16))

key_edu_16 <- key_edu_16 %>% mutate(per_no_hs_diploma_16 = less_9_16 + nd_9_12th_16,
                                    num_25_44yo_16 = num_25_34yo_16 + num_35_44yo_16) # Remeber to calculate percent when tables are joined

# Sum population 25-44

# # Calculate Education change (Change in percentage of population over 25 w/o a bachelors degree)

# Change characters to numbers

key_edu_10$Per_BachelorsPlus_10 <- as.numeric(as.character(key_edu_10$Per_BachelorsPlus_10))
key_edu_16$Per_BachelorsPlus_16 <- as.numeric(as.character(key_edu_16$Per_BachelorsPlus_16))

#Join edu 10 and 16 df's

#Combine economic data for 2010 and 2016
key_edu_10$GEOID10 <- as.character(key_edu_10$GEOID10)
key_edu_16$GEOID10 <- as.character(key_edu_16$GEOID10)
all_years_education<- full_join(key_edu_10, key_edu_16, by = c("GEOID10" = "GEOID10"))

#Calculate percentage change of population 25 and over with a bachelors degree or higher 

edu_change <- all_years_education %>% mutate(college_change = Per_BachelorsPlus_16 - Per_BachelorsPlus_10,
                                             no_diploma_change = per_no_hs_diploma_16 - per_no_hs_diploma_10)

```

### Race Variables

```{r message = FALSE, warning=FALSE}
## Race 2010


race_10 <- read.csv("Data/race2_10.csv", skip = 1)

key_race_10 <- race_10[,c(2:17,26,27)]



race_names_10 <- c("GEOID10", 
               "Census_Tract", 
               "total_pop_10", 
               "total_pop_moe_10",
               "not_hisp_10",
               "not_hisp_moe_10",
               "white_10",
               "white_MOE_10",
               "black_10",
               "black_moe_10",
               "native_10",
               "native_moe_10",
               "asian_10",
               "asian_moe_10",
               "pac_isl_10",
               "pac_isl_moe_10",
               "hisp_10",
               "hisp_moe_10") 

colnames(key_race_10) <- race_names_10


#Calculate percentages

key_race_10 <- key_race_10 %>% mutate(per_white_10 = (white_10/total_pop_10)*100,
                                      per_black_10 = (black_10/total_pop_10)*100,
                                      per_asian_10 = (asian_10/total_pop_10)*100,
                                      per_native_10 = (native_10/total_pop_10)*100,
                                      per_pac_isl_10 = (pac_isl_10/total_pop_10)*100,
                                      per_hisp_10 = (hisp_10/total_pop_10)*100)

# Race 2016


race_16 <- read.csv("Data/race2_16.csv", skip = 1)

key_race_16 <- race_16[,c(2:17,26,27)]


race_names_16 <- c("GEOID10", 
                   "Census_Tract", 
                   "total_pop_16", 
                   "total_pop_moe_16",
                   "not_hisp_16",
                   "not_hisp_moe_16",
                   "white_16",
                   "white_MOE_16",
                   "black_16",
                   "black_moe_16",
                   "native_16",
                   "native_moe_16",
                   "asian_16",
                   "asian_moe_16",
                   "pac_isl_16",
                   "pac_isl_moe_16",
                   "hisp_16",
                   "hisp_moe_16") 

colnames(key_race_16) <- race_names_16


key_race_16 <- key_race_16 %>% mutate(per_white_16 = (white_16/total_pop_16)*100,
                                      per_black_16 = (black_16/total_pop_16)*100,
                                      per_asian_16 = (asian_16/total_pop_16)*100,
                                      per_native_16 = (native_16/total_pop_16)*100,
                                      per_pac_isl_16 = (pac_isl_16/total_pop_16)*100,
                                      per_hisp_16 = (hisp_16/total_pop_16)*100)

# # Calculate change in ethnic composition


#Join race 10 and 16 df's

#Combine race data for 2010 and 2016
key_race_10$GEOID10 <- as.character(key_race_10$GEOID10)
key_race_16$GEOID10 <- as.character(key_race_16$GEOID10)
all_years_race<- full_join(key_race_10, key_race_16, by = c("GEOID10" = "GEOID10"))



#Calculate change in ethnic composition population from 2010-2016 

race_change <- all_years_race %>% mutate(white_change = per_white_16 - per_white_10,
                                         black_change = per_black_16 - per_black_10,
                                         native_change = per_native_16 - per_native_10,
                                         asian_change = per_asian_16 - per_asian_10,
                                         pac_isl_change = per_pac_isl_16 - per_pac_isl_10)

```

### Housing Variables

```{r message=FALSE, warning=FALSE}
# Housing 2010

house_10 <- read.csv("Data/house_10.csv", skip = 1)

key_house_10 <- house_10[,c(2:5,10,11,14,15,16,17,20,21,180:187,200:203,216:223,352,353,452:455,496,497,528,529,560:563)]



house_names_10 <- c("GEOID10", 
                   "Census_Tract", 
                   "total_units_10", 
                   "total_units_moe_10",
                   "per_occ_10",
                   "per_occ_moe_10",
                   "per_vac_10",
                   "per_vac_moe_10",
                   "own_vac_rate_10",
                   "own_vac_rate_moe_10",
                   "rent_vac_rate_10",
                   "rent_vac_rate_moe_10",
                   "own_occ_num_10",
                   "own_occ_num_moe_10",
                   "own_occ_per_10",
                   "own_occ_per_moe_10",
                   "rent_occ_num_10",
                   "rent_occ_num_moe_10",
                   "rent_occ_per_10",
                   "rent_occ_per_moe_10",
                   "move_05plus_num_10",
                   "move_05plus_num_moe_10",
                   "move_05plus_per_10",
                   "move_05plus_per_moe_10",
                   "move_70_79_num_10",
                   "move_70_79_num_moe_10",
                   "move_70_79_per_10",
                   "move_70_79_per_moe_10",
                   "move_69earl_num_10",
                   "move_69earl_num_moe_10",
                   "move_69earl_per_10",
                   "move_69earl_per_moe_10",
                   "median_home_value_10",
                   "median_home_value_moe_10",
                   "SMOCAPI_35plus_num_10",
                   "SMOCAPI_35plus_num_moe_10",
                   "SMOCAPI_35plus_per_10",
                   "SMOCAPI_35plus_per_moe_10",
                   "occ_units_pay_rent_10",
                   "occ_units_pay_rent_moe_10",
                   "median_rent_10",
                   "median_rent_moe_10",
                   "GRAPI_35plus_num_10",
                   "GRAPI_35plus_num_moe_10",
                   "GRAPI_35plus_per_10",
                   "GRAPI_35plus_per_moe_10") 


colnames(key_house_10) <- house_names_10


# Calculate number of long-standing homeowners  (ie 2010 census 1979 or earlier (31+ years))

key_house_10$move_70_79_per_10 <- as.numeric(as.character(key_house_10$move_70_79_per_10))
key_house_10$move_69earl_per_10 <- as.numeric(as.character(key_house_10$move_69earl_per_10))

key_house_10 <- key_house_10 %>% mutate(move_in_30plus_yrs_num = move_70_79_num_10 +move_69earl_num_10,
                                        move_in_30plus_yrs_per = move_70_79_per_10 + move_69earl_per_10)


# House 2016

house_16 <- read.csv("Data/house_16.csv", skip = 1)

key_house_16 <- house_16[,c(2:5,10,11,14,15,16,17,20,21,184:191,204:211,220:227,356,357,460:463,504,505,536:537,568:571)]



house_names_16 <- c("GEOID10", 
                    "Census_Tract", 
                    "total_units_16", 
                    "total_units_moe_16",
                    "per_occ_16",
                    "per_occ_moe_16",
                    "per_vac_16",
                    "per_vac_moe_16",
                    "own_vac_rate_16",
                    "own_vac_rate_moe_16",
                    "rent_vac_rate_16",
                    "rent_vac_rate_moe_16",
                    "own_occ_num_16",
                    "own_occ_num_moe_16",
                    "own_occ_per_16",
                    "own_occ_per_moe_16",
                    "rent_occ_num_16",
                    "rent_occ_num_moe_16",
                    "rent_occ_per_16",
                    "rent_occ_per_moe_16",
                    "move_15plus_num_16",
                    "move_15plus_num_moe_16",
                    "move_15plus_per_16",
                    "move_15plus_per_moe_16",
                    "move_10_14_num_16",
                    "move_10_14_num_moe_16",
                    "move_10_14_per_16",
                    "move_10_14_per_moe_16",
                    "move_80_89_num_16",
                    "move_80_89_num_moe_16",
                    "move_80_89_per_16",
                    "move_80_89_per_moe_16",
                    "move_79earl_num_16",
                    "move_79earl_num_moe_16",
                    "move_79earl_per_16",
                    "move_79earl_per_moe_16",
                    "median_home_value_16",
                    "median_home_value_moe_16",
                    "SMOCAPI_35plus_num_16",
                    "SMOCAPI_35plus_num_moe_16",
                    "SMOCAPI_35plus_per_16",
                    "SMOCAPI_35plus_per_moe_16",
                    "occ_units_pay_rent_16",
                    "occ_units_pay_rent_moe_16",
                    "median_rent_16",
                    "median_rent_moe_16",
                    "GRAPI_35plus_num_16",
                    "GRAPI_35plus_num_moe_16",
                    "GRAPI_35plus_per_16",
                    "GRAPI_35plus_per_moe_16") 


colnames(key_house_16) <- house_names_16


# Calculate number of long-standing homeowners (ie 2016 census 1989, 27+ years or more) and moved in last 6 years

key_house_16$move_80_89_per_16 <- as.numeric(as.character(key_house_16$move_80_89_per_16))
key_house_16$move_79earl_per_16 <- as.numeric(as.character(key_house_16$move_79earl_per_16))
key_house_16$move_15plus_per_16 <- as.numeric(as.character(key_house_16$move_15plus_per_16))
key_house_16$move_10_14_per_16 <- as.numeric(as.character(key_house_16$move_10_14_per_16))

key_house_16 <- key_house_16 %>% mutate(move_in_27plus_yrs_num_16 = move_80_89_num_16 + move_79earl_num_16,
                                        move_in_27plus_yrs_per_16 = move_80_89_per_16 + move_79earl_per_16,
                                        move_recent_num_16 = move_15plus_num_16 + move_10_14_num_16,
                                        move_recent_per_16 = move_15plus_per_16 + move_10_14_per_16)


# Change factor (percent) variables to numeric

# House 2010

key_house_10$per_occ_10 <- as.numeric(as.character(key_house_10$per_occ_10))
key_house_10$per_vac_10 <- as.numeric(as.character(key_house_10$per_vac_10))
key_house_10$own_vac_rate_10 <-as.numeric(as.character(key_house_10$own_vac_rate_10))
key_house_10$rent_vac_rate_10 <-as.numeric(as.character(key_house_10$rent_vac_rate_10))
key_house_10$own_occ_per_10 <-as.numeric(as.character(key_house_10$own_occ_per_10))
key_house_10$rent_occ_per_10 <-as.numeric(as.character(key_house_10$rent_occ_per_10))
key_house_10$move_05plus_per_10 <-as.numeric(as.character(key_house_10$move_05plus_per_10))
key_house_10$SMOCAPI_35plus_per_10 <-as.numeric(as.character(key_house_10$SMOCAPI_35plus_per_10))
key_house_10$median_home_value_10 <-as.numeric(as.character(key_house_10$median_home_value_10))
key_house_10$GRAPI_35plus_per_10 <-as.numeric(as.character(key_house_10$GRAPI_35plus_per_10))
key_house_10$GRAPI_35plus_per_10 <-as.numeric(as.character(key_house_10$GRAPI_35plus_per_10))
key_house_10$median_rent_10 <- as.numeric(as.character(key_house_10$median_rent_10))
# House 2016

key_house_16$per_occ_16 <- as.numeric(as.character(key_house_16$per_occ_16))
key_house_16$per_vac_16 <- as.numeric(as.character(key_house_16$per_vac_16))
key_house_16$own_vac_rate_16 <-as.numeric(as.character(key_house_16$own_vac_rate_16))
key_house_16$rent_vac_rate_16 <-as.numeric(as.character(key_house_16$rent_vac_rate_16))
key_house_16$own_occ_per_16 <-as.numeric(as.character(key_house_16$own_occ_per_16))
key_house_16$rent_occ_per_16 <-as.numeric(as.character(key_house_16$rent_occ_per_16))
key_house_16$move_15plus_per_16 <-as.numeric(as.character(key_house_16$move_15plus_per_16))
key_house_16$SMOCAPI_35plus_per_16 <-as.numeric(as.character(key_house_16$SMOCAPI_35plus_per_16))
key_house_16$median_home_value_16 <-as.numeric(as.character(key_house_16$median_home_value_16))
key_house_16$GRAPI_35plus_per_16 <-as.numeric(as.character(key_house_16$GRAPI_35plus_per_16))
key_house_16$GRAPI_35plus_per_16 <-as.numeric(as.character(key_house_16$GRAPI_35plus_per_16))
key_house_16$median_rent_16 <- as.numeric(as.character(key_house_16$median_rent_16))


#Join house 10 and 16 df's

key_house_10$GEOID10 <- as.character(key_house_10$GEOID10)
key_house_16$GEOID10 <- as.character(key_house_16$GEOID10)
all_years_house<- full_join(key_house_10, key_house_16, by = c("GEOID10" = "GEOID10"))

#Calculate important indicators of change

house_change <- all_years_house %>% mutate(rent_change = median_rent_16 - median_rent_10,
                                      home_value_change = median_home_value_16-median_home_value_10,
                                          rent_occ_change_per = rent_occ_per_16 - rent_occ_per_10,
                                          own_occ_change_per = own_occ_per_16 - own_occ_per_10,
                               GRAPI_35plus_change_per = GRAPI_35plus_per_16 - GRAPI_35plus_per_10,
                         SMOCAPI_35plus_change_per = SMOCAPI_35plus_per_16 - SMOCAPI_35plus_per_10)

```

### Combining all variables from change dataframes

``` {r message=FALSE, warning = FALSE}
econ_edu_join <- full_join(economic_change, edu_change, by = c("GEOID10", "GEOID10"))
econ_edu_race_join <- full_join(econ_edu_join, race_change, by = c("GEOID10", "GEOID10"))
all_gent_var <- full_join(econ_edu_race_join, house_change, by = c("GEOID10", "GEOID10"))

# Calculate percent of people aged 25-44

all_gent_var_new <- all_gent_var %>% mutate(per_25_44_10 = (pop_25_44_10/total_pop_10)*100,
                                            per_25_44_16 = (num_25_44yo_16/total_pop_16)*100,
                                            per_25_44_change = per_25_44_16 - per_25_44_10,
                                            total_pop_chg = total_pop_16 - total_pop_10)

# Select only change variables

gent_change_df <- all_gent_var_new %>% select("GEOID10", contains("change"), contains("chg"))

# Make new df for all 2010 variables with Margins of error for easy access

gent_variables_2010_df <- all_gent_var_new %>% select("GEOID10", contains("_10"), contains("10"))

# Make new df for all 2016 variables with Margins of error for easy access

gent_variables_2016_df <- all_gent_var_new %>% select("GEOID10", contains("_16"), contains("16"))

# Combine new data frames with city of buffalo census tracts to exclude census tracts outside of city limits

buffalo_change_df <- full_join(buffalo_tracts, gent_change_df, by = c("GEOID10"= "GEOID10")) %>% filter(NAME10 != "NA")


buffalo_change_df[is.na(buffalo_change_df)] <- 0

buffalo_2010_df <- full_join(buffalo_tracts, gent_variables_2010_df, by = c("GEOID10"= "GEOID10")) %>% filter(NAME10 != "NA")

buffalo_2016_df <- full_join(buffalo_tracts, gent_variables_2016_df, by = c("GEOID10"= "GEOID10")) %>% filter(NAME10 != "NA")

```

The key variables that I considered to measure gentrification are based on the historical context of Buffalo after rapid deindustrialization and suburbanization that left the inner-city impoverished and segregated. 

In the first step of the analysis I modeled the changes in key socioeconomic variables indicating gentrification and their influence on change in median home value using only census data. The gentrification variables considered for the regression analysis are :

1. Change in the household median income (increase)
2. Change in the percentage of white population (increase)
3. Change in the percentage of the population living in owner occupied housing (increase)
4. Change in the percentage of the population employed in managerial, technical, and professional occupations (increase)
5. Change in median rent (increase)
6. Change in the percentage of the population 25 years of age or older with at least a bachelors degree (increase)
7. Change in percentage of population ages 25-44 years of age (increase)
8. Change in the percentage of the population living below the poverty line (decrease)
9. Change in total population (increase)


The change in all of these variables in each census tract must be considered in comparision to the average change of the City of Buffalo as a whole.

```{r message = FALSE}

# Calculate city change averages in key gentrification variables



mean_white_chg <- mean(buffalo_change_df$white_change)
mean_pov_chg <- mean(buffalo_change_df$Per_Pov_Chg)
mean_income_chg <- mean(buffalo_change_df$Med_Inc_Chg)
mean_college_chg <- mean(buffalo_change_df$college_change)
mean_own_occ_chg <- mean(buffalo_change_df$own_occ_change_per)
mean_prof_occ_chg <- mean(buffalo_change_df$Per_Occ_Mgt_Chg)
mean_total_pop_chg <- mean(buffalo_change_df$total_pop_chg)
mean_adult_chg <- mean(buffalo_change_df$per_25_44_change)
mean_rent_chg <- mean(buffalo_change_df$rent_change)

# create a matrix of the variables 

Var_desc_vector <- c("Change in the percentage of white population (increase)","Change in the percentage of the population living below the poverty line (decrease)","Change in the household median income (increase)","Change in the percentage of the population 25 years of age or older with at least a bachelors degree (increase)","Change in the percentage of the population living in owner occupied housing (increase)","Change in the percentage of the population employed in managerial, technical, and professional occupations (increase)","Change in total population (increase)","Change in percentage of population ages 25-44 years of age (increase)","Change in median rent (increase)")


mean_change_matrix <- matrix(nrow = 9, ncol = 2, c(Var_desc_vector, mean_white_chg, mean_pov_chg, mean_income_chg, mean_college_chg, mean_own_occ_chg, mean_prof_occ_chg, mean_total_pop_chg, mean_adult_chg, mean_rent_chg))

colnames(mean_change_matrix) <- c("Variable", "Mean Change (2010-2016)")

mean_change_df <- as.data.frame(mean_change_matrix)



# Make into a nice html table  

library(knitr)
library(kableExtra)

kable(mean_change_df) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))


```

Changes in the key variables within neighborhoods that experienced a period of disinvestment, represented by concentrated disadvantage in 2000, between 2010 and 2016 establish the gentrification frontier. The gentrification frontier will be categotized as such:

1. Not gentrified - poor
  - Census tracts that remained consistent or have seen decreases in affluent populations
2. Not gentrified - high status
  - Census tracts that may have seen increases in affluent populations but have historically low concentrated disadvantage (less than the median).
3. Potentially gentrifying
  - Disinvested census tracts with some increase in affluent populations 
4. Gentrifying
  - Disinvested census tracts with inreases in at least half of the variables that represented     gentrfication
5. Gentrified
  - Census tracts that have seen increases in all of the gentrification variables.

```{r}
no_gent_high <- Buffalo_ConDis %>% filter(index_00 < 24.7)
no_gent_high_sp <- as(no_gent_high, "Spatial")



gent_frontier <- buffalo_change_df %>% mutate(gent.white = 
                                                ifelse(white_change >= -3.88, 1, 0),
                                              gent.pov = 
                                                ifelse(Per_Pov_Chg <= 1.28, 1, 0),
                                              gent.income = 
                                                ifelse(Med_Inc_Chg >= 3622.72, 1, 0),
                                              gent.college = 
                                                ifelse(college_change >= 1.91, 1, 0),
                                              gent.own = 
                                                ifelse(own_occ_change_per >= -1.55, 1, 0),
                                              gent.prof =
                                                ifelse(Per_Occ_Mgt_Chg >= 1.36, 1, 0),
                                              gent.pop =
                                                ifelse(total_pop_chg >= -88.9, 1, 0),
                                              gent.adult = 
                                                ifelse(per_25_44_change >= 1.56, 1, 0),
                                              gent.rent =
                                                ifelse(rent_change >= 52.14, 1, 0),
                                              gent.rank = gent.white + gent.pov + gent.income + gent.college + gent.own + gent.prof + gent.pop + gent.adult + gent.rent
                                              )
hist(gent_frontier$gent.rank)

gent_frontier_sp <- as(gent_frontier, "Spatial")

?colorBin
gent_bins <- c(0,4,5,6,7,9)
gent_pal <- colorBin(c("#7B241C","#F3F30C","#2ECC71", "#3498DB", "#E525C5"), domain = gent_frontier_sp$gent.rank, bins = gent_bins)

gent_labels <- sprintf("<strong>%f overall rank</strong><br/>%f White Population Change (Percent)<br/>%f Poverty Change (Percent)<br/>%f Median Income Change ($)<br/>%f College Grads Change (Percent)<br/>%f Owner-Occupied Change (Percent)<br/>%f Professional Occupation Change (Percent)<br/>%f Total Population Change<br/>%f Young Adult Population Change (Percent)<br/>%f Median Rent Change ($)",gent_frontier_sp$gent.rank, gent_frontier_sp$white_change, gent_frontier_sp$Per_Pov_Chg, gent_frontier_sp$Med_Inc_Chg, gent_frontier_sp$college_change, gent_frontier_sp$own_occ_change_per, gent_frontier_sp$Per_Occ_Mgt_Chg, gent_frontier_sp$total_pop_chg, gent_frontier_sp$per_25_44_change, gent_frontier_sp$rent_change) %>% 
  lapply(htmltools::HTML)


gent_frontier_map <- leaflet() %>% setView(-78.8784, 42.8864, 10.9) %>% addTiles() %>%
  addPolygons(data = gent_frontier_sp, fillColor = ~gent_pal(gent.rank),
  weight = 0.5,
  opacity = 0.5,
  color = "white",
  dashArray = "3",
  fillOpacity = 0.75,
  highlight = highlightOptions(weight = 5,
    color = "#666",
    dashArray = "",
    fillOpacity = 0.5),
  label = gent_labels,
  labelOptions = labelOptions(
    style = list("font-weight" = "normal", padding = "3px 8px"),
    textsize = "12px",
    direction = "auto"
  ),
  group = "Gentrification Frontier") %>%
      addPolygons(data = no_gent_high_sp, fillColor = "#7D3C98",
                fillOpacity = 0.85,
                weight = 0.5,
  group = "Not Gentrified High Status") %>% 
  addPolygons(data = disinvested_sp, fillOpacity = 0.25,
              fillColor = "#D5D8DC",
              weight = 1.5, 
              opacity = .9,
              color = "#00000",
              group = "Disinvestment areas") %>%
    addPolygons(data = nbhds_json, fillOpacity = 0, 
              weight = 1.2,
              color = "#FFFFFF",
              dashArray = "3",
              highlight = highlightOptions(
                weight = 5,
                color = "#666",
                dashArray = "",
                fillOpacity = 0.4),
                label = nbhds_json$nbhdname,
              labelOptions = labelOptions(
                style = list("font-weight" = "normal", padding = "3px 8px"),
                textsize = "15px",
                direction = "auto"),
              group = "Neighborhoods") %>%
  addLayersControl(overlayGroups = c("Gentrification Frontier", "Not Gentrified High Status", "Disinvestment areas", "Neighborhoods"),
                   options = layersControlOptions(collapsed = FALSE)) %>%
                     addLegend(pal = gent_pal, 
                               values = gent_frontier_sp$gent.rank, 
                               opacity = 0.75,
                               title = "Gentrification Frontier, Buffalo NY 2010-2016",
                               position = "bottomleft")
  
gent_frontier_map

```

From 2010 to 2016, according to the U.S. Census Bureau American Community Survey data, the city of Buffalo as a whole has seen an average increase in six out of the nine variables included in the gentrification assessment, only seeing a decrease in the percentage of white population, percentage of the population living in owner occupied housing, and change in total population. While it is apparent that, according to census data and traditional methods of measuring gentrification, the City of Buffalo is gentrifying as whole. It is imperative to analyze the spatial mismatch of disadvantage and affluence within city neighborhoods before making conclusions about the state of the city.

```{r message = FALSE, warning=FALSE}
# Convert sf to sp in order to convert to geojson for interactive mapping with leaflet

buffalo_change_sp <- as(buffalo_change_df, "Spatial") # Neighborhood change


# Convert to geojson

buffalo_change_json <- geojson_json(buffalo_change_sp)


# Simplify the geometry to decrease storage size of spatial object

buffalo_change_json_simp <- ms_simplify(buffalo_change_json)


# Write as a geojson to bring back into R for mapping

geojson_write(buffalo_change_json_simp, file = "city_change.geojson")


# Read in .geojson to map

city_change <- geojson_read("city_change.geojson", what = "sp")


# Map for interactive view of concentrated disadvantage

summary(city_change$white_change) # Understand range of data
white_bins <- c(-30, -15, -7, 0, 7, 15, 30) # Sets the interval for color scheme based on range
white_pal <- colorBin("RdYlBu", domain = city_change$white_change, bins = white_bins)

labels_white <- sprintf(
  "<strong>%g Percent Change</strong>",
  city_change$white_change
) %>% lapply(htmltools::HTML)

summary(city_change$Per_Pov_Chg) #can use same bins
pov_pal <- colorBin("RdYlBu", domain = city_change$white_change, bins = white_bins, reverse = TRUE) # invert for decreasing being better

labels_pov <- sprintf(
  "<strong>%g Percent Change</strong>",
  city_change$Per_Pov_Chg
) %>% lapply(htmltools::HTML)

summary(city_change$Med_Inc_Chg)

income_bins <- c(-15000, -5000, 0, 5000, 15000, 30000, 55000) 
income_pal <- colorBin("RdYlBu", domain = city_change$Med_Inc_Chg, bins = income_bins) 

labels_income <- sprintf(
  "<strong>%g Dollar Change</strong>",
  city_change$Med_Inc_Chg
) %>% lapply(htmltools::HTML)

summary(city_change$college_change)

college_bins <- c(-70, -30, -15, 0, 5, 15, 30)
college_pal <- colorBin("RdYlBu", domain = city_change$college_change, bins = college_bins) 

labels_college <- sprintf(
  "<strong>%g Percent Change</strong>",
  city_change$college_change
) %>% lapply(htmltools::HTML)

summary(city_change$own_occ_change_per)

homeowners_bins <- c(-20, -10, -5, 0, 5, 10, 15)
homeowners_pal <- colorBin("RdYlBu", domain = city_change$own_occ_change_per, bins = homeowners_bins) 

labels_homeowners <- sprintf(
  "<strong>%g Percent Change</strong>",
  city_change$own_occ_change_per
) %>% lapply(htmltools::HTML)

summary(city_change$Per_Occ_Mgt_Chg)

occupation_bins <- c(-35, -15, -5, 0, 10, 20, 30)
occupation_pal <- colorBin("RdYlBu", domain = city_change$Per_Occ_Mgt_Chg, bins = occupation_bins) 

labels_occupation <- sprintf(
  "<strong>%g Percent Change</strong>",
  city_change$Per_Occ_Mgt_Chg
) %>% lapply(htmltools::HTML)

summary(city_change$total_pop_chg)

pop_bins <- c(-1500, -750, -325, 0, 750, 1500)
pop_pal <- colorBin("RdYlBu", domain = city_change$total_pop_chg, bins = pop_bins) 

labels_pop <- sprintf(
  "<strong>%g Amount Change</strong>",
  city_change$total_pop_chg
) %>% lapply(htmltools::HTML)

summary(city_change$per_25_44_change)

adult_bins <- c(-13, -7, -3, 0, 3, 7, 13)
adult_pal <- colorBin("RdYlBu", domain = city_change$per_25_44_change, bins = adult_bins) 

labels_adult <- sprintf(
  "<strong>%g Percent Change</strong>",
  city_change$per_25_44_change
) %>% lapply(htmltools::HTML)

summary(city_change$rent_change)

rent_bins <- c(-250, -100, -50, 0, 50, 100, 300)
rent_pal <- colorBin("RdYlBu", domain = city_change$rent_change, bins = rent_bins) 

labels_rent <- sprintf(
  "<strong>%g Dollar Change</strong>",
  city_change$rent_change
) %>% lapply(htmltools::HTML)


# Create leaflet map to toggle between layers of gentrification variables

nbhd_chg_map <- leaflet() %>% setView(-78.8784, 42.8864, 10.9) %>% addTiles() %>%
  addPolygons(data = city_change, fillColor = ~white_pal(white_change),
  weight = 0.5,
  opacity = 0.7,
  color = "white",
  dashArray = "3",
  fillOpacity = 0.5,
  highlight = highlightOptions(
    weight = 5,
    color = "#666",
    dashArray = "",
    fillOpacity = 0.5),
  label = labels_white,
  labelOptions = labelOptions(
    style = list("font-weight" = "normal", padding = "3px 8px"),
    textsize = "15px",
    direction = "auto"),
  group = "White Population") %>%
    addPolygons(data = city_change, fillColor = ~pov_pal(Per_Pov_Chg),
  weight = 0.5,
  opacity = 0.7,
  color = "white",
  dashArray = "3",
  fillOpacity = 0.5,
  highlight = highlightOptions(
    weight = 5,
    color = "#666",
    dashArray = "",
    fillOpacity = 0.5),
  label = labels_pov,
  labelOptions = labelOptions(
    style = list("font-weight" = "normal", padding = "3px 8px"),
    textsize = "15px",
    direction = "auto"),
  group = "Poverty") %>%
      addPolygons(data = city_change, fillColor = ~pov_pal(Per_Pov_Chg),
  weight = 0.5,
  opacity = 0.7,
  color = "white",
  dashArray = "3",
  fillOpacity = 0.5,
  highlight = highlightOptions(
    weight = 5,
    color = "#666",
    dashArray = "",
    fillOpacity = 0.5),
  label = labels_pov,
  labelOptions = labelOptions(
    style = list("font-weight" = "normal", padding = "3px 8px"),
    textsize = "15px",
    direction = "auto"),
  group = "Poverty") %>%
      addPolygons(data = city_change, fillColor = ~income_pal(Med_Inc_Chg),
  weight = 0.5,
  opacity = 0.7,
  color = "white",
  dashArray = "3",
  fillOpacity = 0.5,
  highlight = highlightOptions(
    weight = 5,
    color = "#666",
    dashArray = "",
    fillOpacity = 0.5),
  label = labels_income,
  labelOptions = labelOptions(
    style = list("font-weight" = "normal", padding = "3px 8px"),
    textsize = "15px",
    direction = "auto"),
  group = "Median Income") %>%
      addPolygons(data = city_change, fillColor = ~college_pal(college_change),
  weight = 0.5,
  opacity = 0.7,
  color = "white",
  dashArray = "3",
  fillOpacity = 0.5,
  highlight = highlightOptions(
    weight = 5,
    color = "#666",
    dashArray = "",
    fillOpacity = 0.5),
  label = labels_college,
  labelOptions = labelOptions(
    style = list("font-weight" = "normal", padding = "3px 8px"),
    textsize = "15px",
    direction = "auto"),
  group = "College Grads") %>%
      addPolygons(data = city_change, fillColor = ~homeowners_pal(own_occ_change_per),
  weight = 0.5,
  opacity = 0.7,
  color = "white",
  dashArray = "3",
  fillOpacity = 0.5,
  highlight = highlightOptions(
    weight = 5,
    color = "#666",
    dashArray = "",
    fillOpacity = 0.5),
  label = labels_homeowners,
  labelOptions = labelOptions(
    style = list("font-weight" = "normal", padding = "3px 8px"),
    textsize = "15px",
    direction = "auto"),
  group = "Home Owners") %>%
  addPolygons(data = city_change, fillColor = ~occupation_pal(Per_Occ_Mgt_Chg),
  weight = 0.5,
  opacity = 0.7,
  color = "white",
  dashArray = "3",
  fillOpacity = 0.5,
  highlight = highlightOptions(
    weight = 5,
    color = "#666",
    dashArray = "",
    fillOpacity = 0.5),
  label = labels_occupation,
  labelOptions = labelOptions(
    style = list("font-weight" = "normal", padding = "3px 8px"),
    textsize = "15px",
    direction = "auto"),
  group = "Professional Occupation") %>%
  addPolygons(data = city_change, fillColor = ~pop_pal(total_pop_chg),
  weight = 0.5,
  opacity = 0.7,
  color = "white",
  dashArray = "3",
  fillOpacity = 0.5,
  highlight = highlightOptions(
    weight = 5,
    color = "#666",
    dashArray = "",
    fillOpacity = 0.5),
  label = labels_pop,
  labelOptions = labelOptions(
    style = list("font-weight" = "normal", padding = "3px 8px"),
    textsize = "15px",
    direction = "auto"),
  group = "Total Population") %>%
  addPolygons(data = city_change, fillColor = ~adult_pal(per_25_44_change),
  weight = 0.5,
  opacity = 0.7,
  color = "white",
  dashArray = "3",
  fillOpacity = 0.5,
  highlight = highlightOptions(
    weight = 5,
    color = "#666",
    dashArray = "",
    fillOpacity = 0.5),
  label = labels_adult,
  labelOptions = labelOptions(
    style = list("font-weight" = "normal", padding = "3px 8px"),
    textsize = "15px",
    direction = "auto"),
  group = "Adult Population") %>%
  addPolygons(data = city_change, fillColor = ~rent_pal(rent_change),
  weight = 0.5,
  opacity = 0.7,
  color = "white",
  dashArray = "3",
  fillOpacity = 0.5,
  highlight = highlightOptions(
    weight = 5,
    color = "#666",
    dashArray = "",
    fillOpacity = 0.5),
  label = labels_rent,
  labelOptions = labelOptions(
    style = list("font-weight" = "normal", padding = "3px 8px"),
    textsize = "15px",
    direction = "auto"),
  group = "Median Rent") %>%
    addPolygons(data = nbhds_json, fillOpacity = 0, weight = 1, opacity = 1, group = "Neighborhood",
              label = nbhds_json$nbhdname) %>%
  addLayersControl(overlayGroups = c("White Population", "Poverty", "Median Income", "College Grads", "Home Owners", "Professional Occupation", "Total Population", "Adult Population", "Median Rent", "Neighborhoods"),options = layersControlOptions(collapsed = FALSE))
```


### Explore Gentrification Map  

This interactive map allows you to view the key variables of neighborhood change that indicate gentrification in Buffalo NY, simply toggle between layers to view the change. Neighborhoods in blue have encountered the greatest change in terms of gentrification variables while neighborhoods in orange/red have seen a decrease in most variables.

```{r}
nbhd_chg_map
```

## Measuring Gentrification: Traditional Methodology with Open Data Assessment

<br>In recent years, some residential tax parcels have sold for much more than the assessed value and are located in neighborhoods where revitalization efforts have taken place. The total assessment value of each residential tax parcel determines how much a homeowner pays in property taxes each year, thus contributes to the development of city infrastructure. The purpose of this project is to use the city of Buffalo’s Open Data Portal to analyze and visualize gentrification based on the sold price of residential tax parcels above the total assessment value and understand which changing socioeconomic variables play the largest role the amount sold price was over the assessment value.  By using R Studio, I will filter the data set to only include residential tax parcels that were sold between 2010 and 2016 for higher than the assessed value, which I will then group by census tract to portray descriptive statistics for each neighborhood. By using census data provided by the U.S. Census Bureau’s American Community Survey 5-year estimates for 2010 and 2016, I will analyze the socioeconomic change of key indicators of gentrification documented in the literature, also at the census tract level. In order to model this relationship, I will use a multivariate regression model to test the strength of the relationships.</br>

```{r}

# Bring in assessment data

# Create vector for residential tax parcels excluding vacant property 

tax_ass_parcels <- read.csv("Data/assessment18_19.csv")


all_res_parcels <- c("ONE FAMILY DWELLING", 
                  "TWO FAMILY DWELLING",
                  "THREE FAMILY DWELLING",
                  "APARTMENT",
                  "DOWNTOWN ROW TYPE (DETACHED)",
                  "RESIDENTIAL LAND WITH SMALL IMPROVEMENTS",
                  "RESIDENTIAL VACANT LAND")

# Filter the assessment data to only include residential (non-vacant) parcels

res_parcels <- tax_ass_parcels %>% filter(PROPERTY.CLASS.DESCRIPTION %in% all_res_parcels)


# Create dataframes for over and under assessed parcels

under_assessed_parcels <- res_parcels %>% mutate(diff_under = SALE.PRICE - TOTAL.VALUE) %>%
  filter(diff_under > 0)

over_assessed_parcels <- res_parcels %>% mutate(diff_over = SALE.PRICE - TOTAL.VALUE) %>%
  filter(diff_over < 0)



# Filtered over/assessed data by year

year_2015_2018 <-c(2015,2016,2017,2018)

under_assessed_15_18 <- under_assessed_parcels %>% separate(DEED.DATE, c("MONTH", "DAY", "YEAR"), sep = "/") %>%
  filter(YEAR %in% year_2015_2018)

over_assessed_15_18 <- over_assessed_parcels %>% separate(DEED.DATE, c("MONTH", "DAY", "YEAR"), sep = "/") %>%
  filter(YEAR %in% year_2015_2018)

res_parcels_15_18 <- res_parcels %>% separate(DEED.DATE, c("MONTH", "DAY", "YEAR"), sep = "/") %>%
  filter(YEAR %in% year_2015_2018) %>%
  mutate(diff = SALE.PRICE - TOTAL.VALUE)
```

This particular project only focuses on the residential tax parcels that have sold for more than their assessed value from 2010-present. The assessed value of parcels is based on The Assessment Standard Real Property Tax Law RPTL 305. This law states "All Real Property in each Assessing Unit shall be assessed at a UNIFORM PERCENT of value" and "value is defined as market value, or, the most probable sale price in a competitive and open market"(Erie County Real Property Tax Services). Neighborhoods that have properties that sold over the assessment value since the last city-wide reassessment will likely see an increase in their property taxes, even if their house was never on the market. 

```{r}


# Filter the dataset to not include any properties that havent been geocoded 

sold_more <- under_assessed_15_18[!(is.na(under_assessed_15_18$CENSUS.TRACT) | under_assessed_15_18$CENSUS.TRACT==""), c(1,7,9,17:20,24:26,28:49)]

sold_less <- over_assessed_15_18[!(is.na(over_assessed_15_18$CENSUS.TRACT) | over_assessed_15_18$CENSUS.TRACT==""), c(1,7,9,17:20,24:26,28:49)]



# convert sold_more to spatial object using lat and long


sold_more_coords <- sold_more[,c(30,29)]
sold_less_coords <- sold_less[,c(30,29)]




sold_more_sp <- SpatialPointsDataFrame(coords = sold_more_coords, data = sold_more, proj4string = CRS("+proj=tmerc +lat_0=40 +lon_0=-78.58333333333333 +k=0.9999375+x_0=350000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"))

sold_less_sp <- SpatialPointsDataFrame(coords = sold_less_coords, data = sold_less, proj4string = CRS("+proj=tmerc +lat_0=40 +lon_0=-78.58333333333333 +k=0.9999375+x_0=350000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"))


summary(sold_more_sp$diff_under) 
summary(sold_less_sp$diff_over)

sold_more_bins <- c(1,10000,30000,60000,150000,500000,2000000)

sold_less_bins <- c(-26000000, -1000000, -50000, -20000,-10000, -5000, -100)

sold_more_pal <- colorBin("Purples", domain = sold_more_sp$diff_under, bins = sold_more_bins)

sold_less_pal <- colorBin("Reds", domain = sold_less_sp$diff_over, bins = sold_less_bins, reverse = TRUE)


labels_sold_more <- sprintf(
  "<strong>%g sold over last assessment</strong><br/>%s<br/>%s year sold<br/>%s<br/>%s",
  sold_more_sp$diff_under, sold_more_sp$PROPERTY.CLASS.DESCRIPTION, sold_more_sp$YEAR, sold_more_sp$OWNER1, sold_more_sp$ADDRESS
) %>% lapply(htmltools::HTML)

labels_sold_less <- sprintf(
  "<strong>%g sold under last assessment</strong><br/>%s<br/>%s year sold<br/>%s<br/>%s",
  sold_less_sp$diff_over, sold_less_sp$PROPERTY.CLASS.DESCRIPTION, sold_less_sp$YEAR, sold_less_sp$OWNER1, sold_less_sp$ADDRESS
) %>% lapply(htmltools::HTML)

sold_more_map <- leaflet(data = sold_more_sp) %>% setView(-78.8784, 42.8864, 10.9) %>% addTiles() %>%
  addCircleMarkers(lng = sold_more_sp$LONGITUDE, lat = sold_more_sp$LATITUDE, radius = 5, fillColor = ~sold_more_pal(diff_under), fillOpacity = .9, stroke = FALSE, label = labels_sold_more) %>%
  addLegend(pal = sold_more_pal, values = sold_more_sp$diff_under, opacity = 0.7, title = "Amount Property Sold For Above Assessment Value", position = "bottomleft")

sold_less_map <- leaflet(data = sold_less_sp) %>% setView(-78.8784, 42.8864, 10.9) %>% addTiles() %>%
  addCircleMarkers(lng = sold_less_sp$LONGITUDE, lat = sold_less_sp$LATITUDE, radius = 5, fillColor = ~sold_less_pal(diff_over), fillOpacity = .9, stroke = FALSE, label = labels_sold_less) %>%
  addLegend(pal = sold_less_pal, values = sold_less_sp$diff_over, opacity = 0.7, title = "Amount Property Sold For Below Assessment Value", position = "bottomleft")

sold_more_map

house_cluster_map <- leaflet(sold_more_sp) %>% addTiles() %>% addMarkers(lng = sold_more_sp$LONGITUDE, lat = sold_more_sp$LATITUDE,
  clusterOptions = markerClusterOptions(showCoverageOnHover = )
)


house_cluster_map

```


```{r message=FALSE, warning=FALSE}
# Get summaries of data 

## Summaries of data

# Residential parcels sold above assessed value for years 2010-2018


summary_under_15_18 <- under_assessed_15_18 %>% group_by(CENSUS.TRACT) %>%
  summarise(mean_under = mean(diff_under),
            mean_sale_under = mean(SALE.PRICE),
            mean_assessVal_under = mean(TOTAL.VALUE),
            n_under = n(),
            median_sale_under = median(SALE.PRICE),
            median_assessVal_under = median(TOTAL.VALUE),
            median_under = median(diff_under))



# Summary for all residential parcels 2010-2018


all_res_15_18 <- res_parcels_15_18 %>% group_by(CENSUS.TRACT) %>%
  summarise(all_mean_difSale_ass = mean(diff),
            all_mean_sale = mean(SALE.PRICE),
            all_mean_assVal = mean(TOTAL.VALUE),
            total = n(),
            all_median_sale = median(SALE.PRICE),
            all_median_assessVal = median(TOTAL.VALUE),
            all_median_difSale_ass = median(diff)) 


# Residential parcels sold below assessed value for years 2010-2018


summary_over_15_18 <- over_assessed_15_18 %>% group_by(CENSUS.TRACT) %>%
  summarise(mean_over = mean(diff_over),
            mean_sale_over = mean(SALE.PRICE),
            mean_assessVal_over = mean(TOTAL.VALUE),
            n_over = n(),
            median_sale_over = median(SALE.PRICE),
            median_assessVal_over = median(TOTAL.VALUE),
            median_over = median(diff_over))



# Join both tables to calculate the percentage over over and under assessed homes by census tract

over_under_15_18 <- full_join(summary_under_15_18, summary_over_15_18, c("CENSUS.TRACT", "CENSUS.TRACT")) %>% 
  mutate(total_homes = n_under + n_over,
         percent_under = (n_under/total_homes)*100,
         percent_over = (n_over/total_homes)*100)

property_summary <- full_join(over_under_15_18, all_res_15_18, c("CENSUS.TRACT", "CENSUS.TRACT"))


# Perform linear regression for gentrification variables on amount property sold for above assessment value for all residential parcel types

# Model using the average sale above the assessment value for all properties
# Join property summary data with changing gentrification variables 

base_model_mean_df <- full_join(property_summary, buffalo_change_df, by = c("CENSUS.TRACT"="NAME10"))



base_model.1 <- lm(mean_under ~ Med_Inc_Chg + 
                     percent_under + 
                     n_under + 
                     white_change +
                     own_occ_change_per +
                     Per_Occ_Mgt_Chg +
                   rent_change + 
                     college_change + 
                     per_25_44_change +
                     Per_Pov_Chg + 
                     total_pop_chg, data = base_model_mean_df)


# Model using individual properties
# Join census change and property data

assessment_change_df <- full_join(buffalo_change_df, sold_more, by = c("NAME10" = "CENSUS.TRACT"))

base_model_all_df <- full_join(assessment_change_df,property_summary, by = c("NAME10" = "CENSUS.TRACT"))


base_model.2 <- lm(base_model.1 <- lm(diff_under ~ Med_Inc_Chg + 
                     percent_under + 
                     n_under + 
                     white_change +
                     own_occ_change_per +
                     Per_Occ_Mgt_Chg +
                   rent_change + 
                     college_change + 
                     per_25_44_change +
                     Per_Pov_Chg + 
                     total_pop_chg, data = base_model_all_df))

```

```{r}

home_analysis <- c("ONE FAMILY DWELLING", 
                  "TWO FAMILY DWELLING",
                  "THREE FAMILY DWELLING")

# Filter the assessment data to only include residential (non-vacant) parcels

homes <- tax_ass_parcels %>% filter(PROPERTY.CLASS.DESCRIPTION %in% home_analysis)


# Create dataframes for over and under assessed parcels



under_assessed_homes <- homes %>% mutate(diff_under = SALE.PRICE - TOTAL.VALUE) %>%
  filter(diff_under > 0) %>% separate(DEED.DATE, c("MONTH", "DAY", "YEAR"), sep = "/") %>%
  filter(YEAR %in% year_2015_2018)

over_assessed_homes <- homes %>% mutate(diff_over = SALE.PRICE - TOTAL.VALUE) %>%
  filter(diff_over < 0)  %>% separate(DEED.DATE, c("MONTH", "DAY", "YEAR"), sep = "/") %>%
  filter(YEAR %in% year_2015_2018)

all_homes_full <- homes %>% separate(DEED.DATE, c("MONTH", "DAY", "YEAR"), sep = "/") %>%
  filter(YEAR %in% year_2015_2018) %>%
  mutate(diff = SALE.PRICE - TOTAL.VALUE)

# Clean for columns not needed

sold_more_homes <- under_assessed_homes[!(is.na(under_assessed_homes$CENSUS.TRACT) | under_assessed_homes$CENSUS.TRACT==""), c(1,7,9,17:20,24:26,28:49)]
sold_less_homes <- over_assessed_homes[!(is.na(over_assessed_homes$CENSUS.TRACT) | over_assessed_homes$CENSUS.TRACT==""), c(1,7,9,17:20,24:26,28:49)]
all_homes <- all_homes_full[!(is.na(all_homes_full$CENSUS.TRACT) | all_homes_full$CENSUS.TRACT==""), c(1,7,9,17:20,24:26,28:49)]
## Summaries of data

# Residential parcels sold above assessed value for years 2015-2018

summary_under_homes <- sold_more_homes %>% group_by(CENSUS.TRACT) %>%
  summarise(mean_under = mean(diff_under),
            mean_sale_under = mean(SALE.PRICE),
            mean_assessVal_under = mean(TOTAL.VALUE),
            n_under = n(),
            median_sale_under = median(SALE.PRICE),
            median_assessVal_under = median(TOTAL.VALUE),
            median_under = median(diff_under))



# Summary for all residential parcels 2015-2018

summary_all_homes <- all_homes %>% group_by(CENSUS.TRACT) %>%
  summarise(all_mean_difSale_ass = mean(diff),
            all_mean_sale = mean(SALE.PRICE),
            all_mean_assVal = mean(TOTAL.VALUE),
            total = n(),
            all_median_sale = median(SALE.PRICE),
            all_median_assessVal = median(TOTAL.VALUE),
            all_median_difSale_ass = median(diff)) 


# Residential parcels sold below assessed value for years 2010-2018

summary_over_homes <- sold_less_homes %>% group_by(CENSUS.TRACT) %>%
  summarise(mean_over = mean(diff_over),
            mean_sale_over = mean(SALE.PRICE),
            mean_assessVal_over = mean(TOTAL.VALUE),
            n_over = n(),
            median_sale_over = median(SALE.PRICE),
            median_assessVal_over = median(TOTAL.VALUE),
            median_over = median(diff_over))



# Join both tables to calculate the percentage over over and under assessed homes by census tract

more_less_homes_sum <- full_join(summary_under_homes , summary_over_homes, c("CENSUS.TRACT", "CENSUS.TRACT")) %>% 
  mutate(total_homes = n_under + n_over,
         percent_under = (n_under/total_homes)*100,
         percent_over = (n_over/total_homes)*100)

homes_summary <- full_join(more_less_homes_sum, summary_all_homes, c("CENSUS.TRACT", "CENSUS.TRACT"))


# Model with average amount one, two, and three family dwellings sold above assessment value

homes_model_mean_df <- full_join(homes_summary, buffalo_change_df, by = c("CENSUS.TRACT"="NAME10"))



homes_model.1 <- lm(base_model.1 <- lm(mean_under ~ Med_Inc_Chg + 
                     percent_under + 
                     n_under + 
                     white_change +
                     own_occ_change_per +
                     Per_Occ_Mgt_Chg +
                   rent_change + 
                     college_change + 
                     per_25_44_change +
                     Per_Pov_Chg + 
                     total_pop_chg, data = homes_model_mean_df))



# Join census change, property data, and property data sumarries by census tract

homes_change_df <- full_join(buffalo_change_df, sold_more_homes, by = c("NAME10" = "CENSUS.TRACT"))

homes_model_all_df <- full_join(homes_change_df,homes_summary, by = c("NAME10" = "CENSUS.TRACT"))



homes_model.2 <- lm(diff_under ~ Med_Inc_Chg + 
                     percent_under + 
                     n_under + 
                     white_change +
                     own_occ_change_per +
                     Per_Occ_Mgt_Chg +
                   rent_change + 
                     college_change + 
                     per_25_44_change +
                     Per_Pov_Chg + 
                     total_pop_chg, data = homes_model_all_df)


```
```{r}

apt_analysis <- c("APARTMENT", "DOWNTOWN ROW TYPE (DETATCHED)")

# Filter the assessment data to only include residential (non-vacant) parcels

apts <- tax_ass_parcels %>% filter(PROPERTY.CLASS.DESCRIPTION %in% apt_analysis)


# Create dataframes for over and under assessed parcels

under_assessed_apts <- apts %>% mutate(diff_under = SALE.PRICE - TOTAL.VALUE) %>%
  filter(diff_under > 0) %>% separate(DEED.DATE, c("MONTH", "DAY", "YEAR"), sep = "/") %>%
  filter(YEAR %in% year_2015_2018)

over_assessed_apts <- apts %>% mutate(diff_over = SALE.PRICE - TOTAL.VALUE) %>%
  filter(diff_over < 0)  %>% separate(DEED.DATE, c("MONTH", "DAY", "YEAR"), sep = "/") %>%
  filter(YEAR %in% year_2015_2018)

all_apts_full <- apts %>% separate(DEED.DATE, c("MONTH", "DAY", "YEAR"), sep = "/") %>%
  filter(YEAR %in% year_2015_2018) %>%
  mutate(diff = SALE.PRICE - TOTAL.VALUE)

# Clean for columns not needed

sold_more_apts <- under_assessed_apts[!(is.na(under_assessed_apts$CENSUS.TRACT) | under_assessed_apts$CENSUS.TRACT==""), c(1,7,9,17:20,24:26,28:49)]
sold_less_apts <- over_assessed_apts[!(is.na(over_assessed_apts$CENSUS.TRACT) | over_assessed_apts$CENSUS.TRACT==""), c(1,7,9,17:20,24:26,28:49)]
all_apts <- all_apts_full[!(is.na(all_apts_full$CENSUS.TRACT) | all_apts_full$CENSUS.TRACT==""), c(1,7,9,17:20,24:26,28:49)]
## Summaries of data

# Residential parcels sold above assessed value for years 2015-2018

summary_under_apts <- sold_more_apts %>% group_by(CENSUS.TRACT) %>%
  summarise(mean_under = mean(diff_under),
            mean_sale_under = mean(SALE.PRICE),
            mean_assessVal_under = mean(TOTAL.VALUE),
            n_under = n(),
            median_sale_under = median(SALE.PRICE),
            median_assessVal_under = median(TOTAL.VALUE),
            median_under = median(diff_under))



# Summary for all residential parcels 2015-2018

summary_all_apts <- all_apts %>% group_by(CENSUS.TRACT) %>%
  summarise(all_mean_difSale_ass = mean(diff),
            all_mean_sale = mean(SALE.PRICE),
            all_mean_assVal = mean(TOTAL.VALUE),
            total = n(),
            all_median_sale = median(SALE.PRICE),
            all_median_assessVal = median(TOTAL.VALUE),
            all_median_difSale_ass = median(diff)) 


# Residential parcels sold below assessed value for years 2010-2018

summary_over_apts <- sold_less_apts %>% group_by(CENSUS.TRACT) %>%
  summarise(mean_over = mean(diff_over),
            mean_sale_over = mean(SALE.PRICE),
            mean_assessVal_over = mean(TOTAL.VALUE),
            n_over = n(),
            median_sale_over = median(SALE.PRICE),
            median_assessVal_over = median(TOTAL.VALUE),
            median_over = median(diff_over))



# Join both tables to calculate the percentage over over and under assessed homes by census tract

more_less_apts_sum <- full_join(summary_under_apts , summary_over_apts, c("CENSUS.TRACT", "CENSUS.TRACT")) %>% 
  mutate(total_homes = n_under + n_over,
         percent_under = (n_under/total_homes)*100,
         percent_over = (n_over/total_homes)*100)

apts_summary <- full_join(more_less_apts_sum, summary_all_apts, c("CENSUS.TRACT", "CENSUS.TRACT"))


# Model with average amount one, two, and three family dwellings sold above assessment value

apts_model_mean_df <- full_join(apts_summary, buffalo_change_df, by = c("CENSUS.TRACT"="NAME10"))


apts_model.1 <- lm(mean_under ~ Med_Inc_Chg + 
                     percent_under + 
                     n_under + 
                     white_change +
                     own_occ_change_per +
                     Per_Occ_Mgt_Chg +
                   rent_change + 
                     college_change + 
                     per_25_44_change +
                     Per_Pov_Chg + 
                     total_pop_chg, data = apts_model_mean_df)


# Join census change, property data, and property data sumarries by census tract

apts_change_df <- full_join(buffalo_change_df, sold_more_apts, by = c("NAME10" = "CENSUS.TRACT"))

apts_model_all_df <- full_join(apts_change_df,apts_summary, by = c("NAME10" = "CENSUS.TRACT"))


apts_model.2 <- lm(mean_under ~ Med_Inc_Chg + 
                     percent_under + 
                     n_under + 
                     white_change +
                     own_occ_change_per +
                     Per_Occ_Mgt_Chg +
                   rent_change + 
                     college_change + 
                     per_25_44_change +
                     Per_Pov_Chg + 
                     total_pop_chg, data = apts_model_all_df)

```

```{r}

# Regression for vacant lots


vacant_analysis <- c("RESIDENTIAL VACANT LAND", "RESIDENTIAL VACANT LAND WITH SMALL IMPROVEMENTS")

vacant <- tax_ass_parcels %>% filter(PROPERTY.CLASS.DESCRIPTION %in% vacant_analysis)


# Create dataframes for over and under assessed parcels

under_assessed_vacant <- vacant %>% mutate(diff_under = SALE.PRICE - TOTAL.VALUE) %>%
  filter(diff_under > 0) %>% separate(DEED.DATE, c("MONTH", "DAY", "YEAR"), sep = "/") %>%
  filter(YEAR %in% year_2015_2018)

over_assessed_vacant <- vacant %>% mutate(diff_over = SALE.PRICE - TOTAL.VALUE) %>%
  filter(diff_over < 0)  %>% separate(DEED.DATE, c("MONTH", "DAY", "YEAR"), sep = "/") %>%
  filter(YEAR %in% year_2015_2018)

all_vacant_full <- vacant %>% separate(DEED.DATE, c("MONTH", "DAY", "YEAR"), sep = "/") %>%
  filter(YEAR %in% year_2015_2018) %>%
  mutate(diff = SALE.PRICE - TOTAL.VALUE)

# Clean for columns not needed

sold_more_vacant <- under_assessed_vacant[!(is.na(under_assessed_vacant$CENSUS.TRACT) | under_assessed_vacant$CENSUS.TRACT==""), c(1,7,9,17:20,24:26,28:49)]
sold_less_vacant <- over_assessed_vacant[!(is.na(over_assessed_vacant$CENSUS.TRACT) | over_assessed_vacant$CENSUS.TRACT==""), c(1,7,9,17:20,24:26,28:49)]
all_vacant <- all_vacant_full[!(is.na(all_vacant_full$CENSUS.TRACT) | all_vacant_full$CENSUS.TRACT==""), c(1,7,9,17:20,24:26,28:49)]
## Summaries of data

# Residential parcels sold above assessed value for years 2015-2018

summary_under_vacant <- sold_more_vacant %>% group_by(CENSUS.TRACT) %>%
  summarise(mean_under = mean(diff_under),
            mean_sale_under = mean(SALE.PRICE),
            mean_assessVal_under = mean(TOTAL.VALUE),
            n_under = n(),
            median_sale_under = median(SALE.PRICE),
            median_assessVal_under = median(TOTAL.VALUE),
            median_under = median(diff_under))



# Summary for all residential parcels 2015-2018

summary_all_vacant <- all_vacant %>% group_by(CENSUS.TRACT) %>%
  summarise(all_mean_difSale_ass = mean(diff),
            all_mean_sale = mean(SALE.PRICE),
            all_mean_assVal = mean(TOTAL.VALUE),
            total = n(),
            all_median_sale = median(SALE.PRICE),
            all_median_assessVal = median(TOTAL.VALUE),
            all_median_difSale_ass = median(diff)) 


# Residential parcels sold below assessed value for years 2010-2018

summary_over_vacant <- sold_less_vacant %>% group_by(CENSUS.TRACT) %>%
  summarise(mean_over = mean(diff_over),
            mean_sale_over = mean(SALE.PRICE),
            mean_assessVal_over = mean(TOTAL.VALUE),
            n_over = n(),
            median_sale_over = median(SALE.PRICE),
            median_assessVal_over = median(TOTAL.VALUE),
            median_over = median(diff_over))



# Join both tables to calculate the percentage over over and under assessed homes by census tract

more_less_vacant_sum <- full_join(summary_under_vacant , summary_over_vacant, c("CENSUS.TRACT", "CENSUS.TRACT")) %>% 
  mutate(total_homes = n_under + n_over,
         percent_under = (n_under/total_homes)*100,
         percent_over = (n_over/total_homes)*100)

vacant_summary <- full_join(more_less_vacant_sum, summary_all_vacant, c("CENSUS.TRACT", "CENSUS.TRACT"))


# Model with average amount one, two, and three family dwellings sold above assessment value

vacant_model_mean_df <- full_join(vacant_summary, buffalo_change_df, by = c("CENSUS.TRACT"="NAME10"))


vacant_model.1 <- lm(mean_under ~ Med_Inc_Chg + 
                     percent_under + 
                     n_under + 
                     white_change +
                     own_occ_change_per +
                     Per_Occ_Mgt_Chg +
                   rent_change + 
                     college_change + 
                     per_25_44_change +
                     Per_Pov_Chg + 
                     total_pop_chg, data = vacant_model_mean_df)


# Join census change, property data, and property data sumarries by census tract

vacant_change_df <- full_join(buffalo_change_df, sold_more_vacant, by = c("NAME10" = "CENSUS.TRACT"))

vacant_model_all_df <- full_join(vacant_change_df,vacant_summary, by = c("NAME10" = "CENSUS.TRACT"))


vacant_model.2 <- lm(mean_under ~ Med_Inc_Chg + 
                     percent_under + 
                     n_under + 
                     white_change +
                     own_occ_change_per +
                     Per_Occ_Mgt_Chg +
                   rent_change + 
                     college_change + 
                     per_25_44_change +
                     Per_Pov_Chg + 
                     total_pop_chg, data = vacant_model_all_df)

```
# Results
```{r}
summary(base_model.1)
```

Modeling using the average sold price of homes (n = 65) for each census tract gives little insight into which socioeconomic variables contribute to how much a parcel sold for over its assessed value in Buffalo, NY from 2015-2018. The coefficient of determination (Adjusted R-squared) is 0.7192, meaning that the model explains about 72 percent of variability in sale price over the assessed parcels value, only three of the explanatory variables are statistically significant.

- Change in Median Income ($)
- Percentage of residential tax parcels sold above its assessed value in each census tract
- Total residential tax parcels sold between 2013 and 2017 in each census tract 

```{r}
summary(base_model.2)
```

Modeling using the individual parcels for all residential parcels (n = 6,295) provides some insight into the socioeconomic explanatory variables that contribute to the variablity in the amount individual residential parcels sold for above the assessed value. The explanatory power of this model however, is very small (Adjusted R-squared), only explaining approximately 4.1 percent of the variability. One more gentrification variable proves statistically significant:

- Percent change of owner occupied housing (2010-2016)

Holding all else equal according to this model dictates that for each percentage increase in onwer occupied housing, the sold price of the home decreases by about 1,622 dollars. Comparing the first two models in terms of change in median income dictates:

1. Holding all else equal, for each dollar increase in a census tract's median income, the average sold price of parcels sold above the assessed value increases by $1.79.

2. Holding all else equal, for each dollar increase in a census tract's median income, the sold price of a parcel sold above the assessed value increases by $1.40.

Comparing the statistically significant explantory variables in each model can potentially allow one to make inferences on the strength of the gentrification variables in model 2, despite its low coefficient of determination. In an attempt to add explanatory power to the model, I evaluated the variability in property class type.

```{r}
summary(sold_more$diff_under)

sold_more_plot <- sold_more %>% ggplot(mapping = aes(x = YEAR, y = diff_under, color = PROPERTY.CLASS.DESCRIPTION)) +geom_point() + geom_jitter() + labs(x = "Year", y = "Amount Sold Above Assessed Value", title = "Variability of Property Type", subtitle = "Residential Parcels Sold 2015-2018")

sold_more_plot

```

This showed that there is substantial variability in the amount that apartments, residential vacant land (with and without small improvements), and downtown row type housing sold for above its assessed value. I used the same explanatory variables to model gentrification's impact on the sold price of residential parcels by property type and analyzed the similarities and differences between models.

1. Apartments & Downtown Row Houses
2. Residential Vacant Land & Residential Vacant Land with Small Improvements
3. One, two, and three family dwellings

```{r}
summary(apts_model.1)

```

Modeling the explanatory power of gentrification variables on sold price of apartments and row houses whose market value was over the assessed value proved statistically insignificant (n = 30). Not every census tract has apartments, thus decreasing the sample size and only one explanatory variable in the entire model was statistically significant, change in median rent (2010-2016), but only at a 90% confidence interval.

```{r}
summary(apts_model.2)
```

The model that used individual apartment and row house parcels was statistically significant at a 90% confidence interval and the adjusted R-squared decreased from the original model that used all residential tax parcels from explaining 4.1% to 3.3% of gentrification variables impact on the market value over assessed value of residential tax parcels. Statistically significant variables for this model were: 

1. Change in median income

- holding all else equal for every dollar increase in median income within a census tract, the amount an apartment or row house sold for above assessment value increases by $36.43

2. Change in median rent

- holding all else equal for every dollar increase in median rent within a census tract, the amount an apartment or row house sold for above assessment value decreases by $3,256.20

3. Change in the percentage of the population below the poverty line

- holding all else equal for every percent increase in the population below the poverty line within a census tract, the amount an apartment or row house sold for above assessment value decreases by $32,027.29

```{r}
summary(vacant_model.1)
```

The model for assessing the influence of gentrification variables on the average sold price of residential vacant land, with and without small improvements (n = 37), was statistically significant, however had less explanatory power than the model encompassing all residential tax parcels. The adjusted R-squared was .3836 and the model contained three statistically explanatory variables at a 90% confidence interval: 

1. Change in median rent

- Holding all else equal for every dollar increase in median rent within a census tract, the amount a residential vacant parcel sold for above assessment value increases by $450.55

2. Change in the percentage of the population aged between 25 and 44

- holding all else equal for every percent increase in the population aged between 25 and 44 within a census tract, the amount a vacant parcel sold for above assessment value decreases by $7,009.21

3. Change in median income

- Holding all else equal for every dollar increase in median income within a census tract, the amount a residential vacant parcel sold for above assessment value decreases by $4.13

```{r}

summary(vacant_model.2)

```
The model for individual vacant parcels (n = 208) proved statistically significant and the coefficient of determination improved from the original model (n = 6,295) by over ten percent, going from an explanatory power of 4.1% to 14.8%. Two explanatory gentrfication variables were statistically significant:

1. Change in median rent

- Holding all else equal for every dollar increase in median rent within a census tract, the amount a residential vacant parcel sold for above assessment value increases by $713.31

2. Change in the percentage of the population aged between 25 and 44

- holding all else equal for every percent increase in the population aged between 25 and 44 within a census tract, the amount a vacant parcel sold for above assessment value decreases by $9,449.04

```{r}
summary(homes_model.1)

```
The explanatory power of gentrification variables on the average sold price of one, two, and three family dwellings over the assessed value from 2015-2018 (n = 65) was nearly identical to modelling the average market value of all residential tax parcels. Decreasing slightly from 71.9% to 71.6%, this model had only one statistically significant gentrification variable.

1. Change in the percentage of the population over 25 years old with a bachelors degree or higher.

- Holding all else equal, for every percentage increase in the population over 25 years old with a bachelors degree or higher, the average sold price over the assessment value decreases by $1,351.

```{r}
summary(homes_model.2)

```
I found that out of all the models that use individual tax parcels sold above the assessed value between 2015 and 2018, using the sold price of one, two, and three family dwellings as the independent variable (n = 5,582) had the most explanatory power with an adjusted R-squared of 0.3286. This model also has the most statistically significant genrification variables, with six out of nine variables at a 90% confidence interval.

1. Change in percentage of white population

- Holding all else equal, for each percentage increase in white population within a census tract, the sold price of a one, two, or three family dwelling above assessed value increases by $173.80

2. Change in the percentage of owner occupied housing units

- Holding all else equal, for each percentage increase in owner occupied housing units within a census tract, the sold price of a one, two, or three family dwelling above assessed value decreases by $713.80

3. Change in median rent

- Holding all else equal, for each dollar increase in median rent within a census tract, the sold price of a one, two, or three family dwelling above assessed value increases by $42.62

4. Change in the percentage of the population 25 years old or more with a bachelors degree or higher

- Holding all else equal, for each percentage increase in population 25 years old or more with a bachelors degree or higher within a census tract, the sold price of a one, two, or three family dwelling above assessed value decreases by $1,010

5. Change in the percentage of the population aged between 25 and 44 years old

- Holding all else equal, for each percentage increase in the population aged between 25 and 44 years old within a census tract, the sold price of a one, two, or three family dwelling above assessed value increases by $369.80

6. Change in the percentage of the populaton below the poverty line

Holding all else equal, for each percentage increase in the populaton below the poverty line within a census tract, the sold price of a one, two, or three family dwelling above assessed value increases by $329.40

```{r}


library(finalfit)

explanatory <- c("Change in Median Income", "Percent Sold Over Assessment", "No. Sold Over Assessment", "Change in White Population (%)", "Change in Owner Occupied Housing (%)", "Change in Population Employed in Managerial or Technical Professions (%)", "Change in Population 25 or More with Bachelors Degree or Higher (%)", "Change in Population aged 25-44 y/o (%)", "Change in Poverty (%)", "Change in Total Population")







```


# Conclusions

What have you learned?  Are there any broader implications?

# References 

Freeman, Lance (2009). Neighbourhood Diversity, Metropolitan Segregation and Gentrification: What Are the Links in the US? Urban Studies 46(10), 2079-2101.

Holm, Andrej & Schulz, Guido (2017). Gentrimap: A Model for Measuring Gentrification and Displacement. Gentrification and Resistance: Researching Displacement Processes and Adaption Strategies. Springer VS, 251-277

Heidkamp, Patrick C & Lucas, Susan (2006). Finding the Gentrification Frontier Using Census Data: The Case of Portland, Maine. Urban Geography 27(2), 101-125.

LeGates, R., & Hartman, C. (1982). Gentrification-Caused Displacement. The Urban Lawyer, 14(1), 31-55. 

Zook et al (2017). Big Data and the City. Handbook of Urban Geography, 1-12.

